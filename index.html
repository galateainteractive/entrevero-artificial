<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrevero_AI</title>
    <style>
        * { box-sizing: border-box; }

        body {
            background-color: #1a1a1a;
            color: #00ff41; 
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        h1 { 
            margin-bottom: 20px; 
            letter-spacing: 2px;
            font-size: 1.8rem; 
            text-align: center;
        }

        .main-container {
            border: 1px solid #333;
            padding: 25px;
            background: #222;
            border-radius: 8px;
            text-align: center;
            width: 100%;       
            max-width: 360px;  
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
        }

        #coverDisplay {
            width: 100%;
            height: auto;
            aspect-ratio: 1 / 1; 
            background-color: #000;
            border: 1px solid #00ff41;
            margin-bottom: 20px;
            object-fit: cover; 
            display: none; 
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        #btnControl {
            background: #00ff41;
            color: #000;
            border: none;
            padding: 20px 0;
            font-size: 22px;
            font-weight: 900;
            cursor: pointer;
            width: 100%;
            margin-bottom: 20px;
            text-transform: uppercase;
            transition: all 0.2s;
            border-radius: 4px;
            touch-action: manipulation;
        }
        #btnControl:hover { background: #fff; transform: scale(1.02); }
        #btnControl:active { transform: scale(0.98); }
        
        #btnControl.stop-mode {
            background: #ff0055;
            color: #fff;
            box-shadow: 0 0 15px #ff0055;
        }

        .track-list-label {
            font-size: 10px;
            color: #888;
            margin-bottom: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .track-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .track-btn {
            background: transparent;
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 12px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .track-btn:hover { background: rgba(0, 255, 65, 0.1); }
        
        .track-btn.active-track {
            background: #00ff41;
            color: #000;
        }

        #status { margin-bottom: 10px; font-weight: bold; font-size: 14px; min-height: 20px;}
        
        #log {
            font-size: 11px;
            color: #666;
            height: 100px;
            overflow-y: hidden;
            border-top: 1px solid #444;
            padding-top: 10px;
            text-align: center;
            display: flex;
            flex-direction: column-reverse; 
        }
    </style>
</head>
<body>

    <h1>ENTREVERO_AI</h1>

    <div class="main-container">
        <div id="status">SISTEMA ONLINE</div>
        
        <img id="coverDisplay" src="" alt="Capa">

        <button id="btnControl" onclick="togglePlay()">INICIAR</button>

        <div class="track-list-label">SELECIONAR MÓDULO:</div>
        <div class="track-buttons-container" id="trackList">
            </div>

        <div id="log"></div>
    </div>

    <script>
    // --- CONFIGURAÇÃO ---
        const playlistConfig = [
            {
                label: "modulo_a",
                folder: "modulo_a",
                prefix: "A_01",
                totalFiles: 12,   // Conferido no print
                totalImages: 1
            },
            {
                label: "modulo_b",
                folder: "modulo_b",
                prefix: "B_01",
                totalFiles: 10,   // Conferido no print
                totalImages: 1
            },
            {
                label: "modulo_c",
                folder: "modulo_c",
                prefix: "C_01",
                totalFiles: 14,   // Conferido no print
                totalImages: 1
            },
            {
                label: "modulo_d",
                folder: "modulo_d",
                prefix: "D_01",
                totalFiles: 14,   // Conferido no print (do 1 ao 14)
                totalImages: 1
            },
            {
                label: "modulo_e",
                folder: "modulo_e",
                prefix: "E_01",
                totalFiles: 20,   // Conferido no print
                totalImages: 1
            },
            {
                label: "modulo_f",
                folder: "modulo_f",
                prefix: "F_01",
                totalFiles: 7,    // Conferido no print
                totalImages: 1
            },
            {
                label: "modulo_g",
                folder: "modulo_g",
                prefix: "G_01",
                totalFiles: 6,    // Conferido no print
                totalImages: 1
            },
        ];

    // --- VARIÁVEIS ---
    let audioCtx;
    let isPlaying = false;
    let currentSource = null;
    let nextBuffer = null;
    let nextFilename = ""; 
    let currentTrackIndex = 0; 
    let shuffleBags = {}; 

    // --- INICIALIZAÇÃO ---
    window.onload = function() {
        createTrackButtons();
        document.getElementById('status').innerText = "AGUARDANDO...";
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        preloadNextTrack(); 
    };

    function createTrackButtons() {
        const container = document.getElementById('trackList');
        container.innerHTML = "";
        playlistConfig.forEach((track, index) => {
            let btn = document.createElement('button');
            btn.className = 'track-btn';
            btn.innerText = track.label;
            if (index === 0) btn.classList.add('active-track');
            
            btn.onclick = () => changeTrack(index);
            container.appendChild(btn);
        });
    }

    // --- MUDANÇA DE FAIXA ---
    function changeTrack(index) {
        if (index === currentTrackIndex && isPlaying) return; 
        
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (currentSource) {
            try { currentSource.stop(); } catch(e) {}
            currentSource = null;
        }

        currentTrackIndex = index;
        updateButtonsVisual();
        nextBuffer = null;
        
        isPlaying = true;
        const btn = document.getElementById('btnControl');
        btn.innerText = "PARAR";
        btn.classList.add("stop-mode");
        document.getElementById('status').innerText = "CARREGANDO...";

        preloadNextTrack(); 
    }

    function updateButtonsVisual() {
        const buttons = document.querySelectorAll('.track-btn');
        buttons.forEach((btn, idx) => {
            if (idx === currentTrackIndex) btn.classList.add('active-track');
            else btn.classList.remove('active-track');
        });
    }

    // --- CONTROLE PRINCIPAL ---
    function togglePlay() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (isPlaying) stopNow();
        else playNow();
    }

    function playNow() {
        isPlaying = true;
        const btn = document.getElementById('btnControl');
        btn.innerText = "PARAR";
        btn.classList.add("stop-mode");

        if (nextBuffer) {
            playBuffer(nextBuffer, nextFilename);
        } else {
            document.getElementById('status').innerText = "BUFFERING...";
        }
    }

    function stopNow() {
        isPlaying = false;
        if (currentSource) {
            try { currentSource.stop(); } catch(e) {}
            currentSource = null;
        }
        const btn = document.getElementById('btnControl');
        btn.innerText = "TOCAR";
        btn.classList.remove("stop-mode");
        document.getElementById('status').innerText = "PAUSADO";
    }

    function playBuffer(buffer, filename) {
        if (!isPlaying) return;

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);
        source.start(0);
        currentSource = source;

        updateLog(); 
        updateCoverArt(); 

        document.getElementById('status').innerText = "TRANSMITINDO...";

        nextBuffer = null;
        source.onended = function() { if (isPlaying) playNow(); };
        preloadNextTrack();
    }

    function updateCoverArt() {
        const trackConfig = playlistConfig[currentTrackIndex];
        const imgElement = document.getElementById('coverDisplay');

        if (!trackConfig.totalImages || trackConfig.totalImages <= 0) {
            imgElement.style.display = 'none';
            return;
        }

        const randomImg = Math.floor(Math.random() * trackConfig.totalImages) + 1;
        const folderPath = trackConfig.folder ? trackConfig.folder + "/" : "";
        const imagePath = `${folderPath}cover_${randomImg}.jpg`;

        imgElement.src = imagePath;
        imgElement.style.display = 'block';
    }

    async function preloadNextTrack() {
        const file = getNextRandomFile();
        nextFilename = file; 
        try {
            const response = await fetch(file);
            if (!response.ok) throw new Error("404");
            const arrayBuffer = await response.arrayBuffer();
            audioCtx.decodeAudioData(arrayBuffer, (decodedBuffer) => {
                nextBuffer = decodedBuffer;
                if (isPlaying && !currentSource) playNow();
                if (!isPlaying) document.getElementById('status').innerText = "PRONTO.";
            });
        } catch (e) {
            console.error("Erro download", e);
            setTimeout(preloadNextTrack, 1000);
        }
    }

    function getNextRandomFile() {
        const trackConfig = playlistConfig[currentTrackIndex];
        if (!shuffleBags[trackConfig.label]) shuffleBags[trackConfig.label] = [];
        let bag = shuffleBags[trackConfig.label];

        if (bag.length === 0) {
            for (let i = 1; i <= trackConfig.totalFiles; i++) bag.push(i);
            for (let i = bag.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [bag[i], bag[j]] = [bag[j], bag[i]];
            }
        }
        let choice = bag.pop();
        let folderPath = trackConfig.folder ? trackConfig.folder + "/" : "";
        return `${folderPath}${trackConfig.prefix}_VAR_${choice}.mp3`;
    }

    function updateLog() {
        const log = document.getElementById('log');
        const colors = ["#00ff41", "#ff0055", "#00ccff", "#ffff00"];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        let wave = "";
        let len = Math.floor(Math.random() * 10) + 5; 
        for(let i=0; i<len; i++) wave += "|"; 
        log.innerHTML = `<div style="color:${randomColor}; letter-spacing:3px; opacity:0.7;">${wave}</div>` + log.innerHTML;
    }
    </script>
</body>
</html>
